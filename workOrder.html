<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>work order —— Powered by godyu</title>
    <meta name="description" content="工单总结系统">
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <!--<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">-->
    <!--<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>-->
    <style type="text/css">

    </style>
</head>
<body style="width:1024px; margin:20px auto;">
<div style="width:410px;margin-right:14px;float:left";>

    <label>请输入域名：</label>
    <input type="text" id="host" placeholder="http://之后:之前" style="width: 200px">
    <br/>
    <label>请输入日期：</label>
    <input type="text" id="date" placeholder="示例： 2020-01-01" style="width: 200px">
    <input type="button" id="submit" value="提交">
    <table width="100%" style="margin-top: 20px;">
        <thead>
            <th width="40%">总数</th>
            <th width="15%">成功</th>
            <th width="15%">失败</th>
            <th width="15%">处理中</th>
            <th width="15%">未处理</th>
        </thead>
        <tbody id="dataTotal">

        </tbody>
    </table>
    <hr/>
    <table width="100%">
        <thead>
            <th width="25%">主要问题</th>
            <th width="15%">TV</th>
            <th width="15%">IOS</th>
            <th width="15%">Android</th>
            <th width="15%">ipad</th>
            <th width="15%">占比</th>
        </thead>
        <tbody id="dataTable">

        </tbody>
    </table>
    <hr/>
</div>
<div style="width: 600px;float:left;">
    <textarea id="content" style="width: 100%;height: 600px"></textarea>
</div>
</body>
</html>
<script>
    $("#submit").click(function () {
        var date = $("#date").val();
        if (date.indexOf("-")==-1||date.length!=10||date.indexOf("-")!=4||date.lastIndexOf("-")!=7) {
            return false;
        }
        var host=$("#host").val();
        getData(host,date);
    })
    function getData(host,date) {
        /**
         * 定义content,用作拼接Markdown
         */
        var content="";
        /**
         * 获取工单总数及占比
         */
        var unprocessedUrl = "http://"+host+":3100/work_order/get_work_order_data?page_number=1&page_size=200&work_order_status=0&work_order_category=&work_order_no=&work_order_solution=&work_order_type=&platform=&user_phone=&create_time="+date;
        var processingUrl = "http://"+host+":3100/work_order/get_work_order_data?page_number=1&page_size=200&work_order_status=1&work_order_category=&work_order_no=&work_order_solution=&work_order_type=&platform=&user_phone=&create_time="+date;
        var successUrl = "http://"+host+":3100/work_order/get_work_order_data?page_number=1&page_size=200&work_order_status=2&work_order_category=&work_order_no=&work_order_solution=&work_order_type=&platform=&user_phone=&create_time="+date;
        var failUrl = "http://"+host+":3100/work_order/get_work_order_data?page_number=1&page_size=200&work_order_status=3&work_order_category=&work_order_no=&work_order_solution=&work_order_type=&platform=&user_phone=&create_time="+date;

        //获取未处理的工单信息
        var unprocessedResult = (function() {var result;$.ajax({url:unprocessedUrl, dataType:'json', async:false, success:function(data){result = data;}});return result;})();
        //获取处理中的工单信息
        var processingResult = (function() {var result;$.ajax({url:processingUrl, dataType:'json', async:false, success:function(data){result = data;}});return result;})();
        //获取处理成功的工单信息
        var successResult = (function() {var result;$.ajax({url:successUrl, dataType:'json', async:false, success:function(data){result = data;}});return result;})();
        //获取处理失败的工单信息
        var failResult = (function() {var result;$.ajax({url:failUrl, dataType:'json', async:false, success:function(data){result = data;}});return result;})();
        //获取4种状态的工单总数
        var unprocessedTotal = unprocessedResult.total_size;
        var processingTotal = processingResult.total_size;
        var successTotal = successResult.total_size;
        var failTotal = failResult.total_size;
        //获取工单总数
        var sum = unprocessedTotal+ processingTotal+ successTotal+ failTotal;
        //获取占比
        var unprocessedProportion=Math.round(unprocessedTotal / sum * 10000) / 100 + "%";
        var processingProportion=Math.round(processingTotal / sum * 10000) / 100 + "%";
        var successProportion=Math.round(successTotal / sum * 10000) / 100 + "%";
        var failProportion=Math.round(failTotal / sum * 10000) / 100 + "%";
        //打印到页面
        $("#dataTotal").html("<tr><td>"+sum+"</td><td>"+successTotal+"</td><td>"+failTotal+"</td><td>"+processingTotal+"</td><td>"+unprocessedTotal+"</td></tr>"+
            "<tr><td></td><td>"+successProportion+"</td><td>"+failProportion+"</td><td>"+processingProportion+"</td><td>"+unprocessedProportion+"</td></tr>");
        //拼接content
        content += "### 问题总结：\n总数 | 成功 | 失败 | 处理中 | 未处理 \n------------------|---------------------|----------------------|----------------------|----------------------"
            +"\n | "+sum+" | "+successTotal+"  | "+failTotal+"  |  "+processingTotal+" | "+unprocessedTotal
            +"\n |    | "+successProportion+" | "+failProportion+" | "+processingProportion+" | "+unprocessedProportion+"\n*** \n\n";
        /**
         * 获取问题描述
         */
        var categoryNameList = [];
        //获取未处理工单问题描述
        if (unprocessedTotal > 0) {
            $.each(unprocessedResult.customer_work_order_management, function (idx, item) {
                var categoryName = item.work_order_category[0].work_order_category_name;
                if (categoryNameList.indexOf(categoryName) == -1) {
                    categoryNameList.push(categoryName);
                }
            });
        }
        //获取处理中工单问题描述
        if (processingTotal > 0) {
            $.each(processingResult.customer_work_order_management, function (idx, item) {
                var categoryName = item.work_order_category[0].work_order_category_name;
                if (categoryNameList.indexOf(categoryName) == -1) {
                    categoryNameList.push(categoryName);
                }
            });
        }
        //获取处理成功工单问题描述
        if (successTotal > 0) {
            $.each(successResult.customer_work_order_management, function (idx, item) {
                var categoryName = item.work_order_category[0].work_order_category_name;
                if (categoryNameList.indexOf(categoryName) == -1) {
                    categoryNameList.push(categoryName);
                }
            });
        }
        //获取处理失败工单问题描述
        if (failTotal > 0) {
            $.each(failResult.customer_work_order_management, function (idx, item) {
                var categoryName = item.work_order_category[0].work_order_category_name;
                if (categoryNameList.indexOf(categoryName) == -1) {
                    categoryNameList.push(categoryName);
                }
            });
        }
        /**
         * 统计各问题中各终端数量
         */
        var dataTableContent = "";
        //定义故障占比临时变量,用作拼接content
        var tempContent="";
        $.each(categoryNameList, function (idx, item) {
            var tv = 0;
            var ios = 0;
            var aph = 0;
            var ipad = 0;
            //统计未处理工单下终端
            if (unprocessedTotal > 0) {
                $.each(unprocessedResult.customer_work_order_management, function (idx2, item2) {
                    if (item == item2.work_order_category[0].work_order_category_name) {
                        if (item2.platform == 1) {
                            aph += 1;
                        } else if (item2.platform == 4) {
                            tv += 1;
                        } else if (item2.platform == 8) {
                            ios += 1;
                        } else if (item2.platform == 16) {
                            ipad += 1;
                        }
                    }
                })
            }
            //统计处理中工单下终端
            if (processingTotal > 0) {
                $.each(processingResult.customer_work_order_management, function (idx2, item2) {
                    if (item == item2.work_order_category[0].work_order_category_name) {
                        if (item2.platform == 1) {
                            aph += 1;
                        } else if (item2.platform == 4) {
                            tv += 1;
                        } else if (item2.platform == 8) {
                            ios += 1;
                        } else if (item2.platform == 16) {
                            ipad += 1;
                        }
                    }
                })
            }
            //统计处理成功工单下终端
            if (successTotal > 0) {
                $.each(successResult.customer_work_order_management, function (idx2, item2) {
                    if (item == item2.work_order_category[0].work_order_category_name) {
                        if (item2.platform == 1) {
                            aph += 1;
                        } else if (item2.platform == 4) {
                            tv += 1;
                        } else if (item2.platform == 8) {
                            ios += 1;
                        } else if (item2.platform == 16) {
                            ipad += 1;
                        }
                    }
                })
            }
            //统计处理失败工单下终端
            if (failTotal > 0) {
                $.each(failResult.customer_work_order_management, function (idx2, item2) {
                    if (item == item2.work_order_category[0].work_order_category_name) {
                        if (item2.platform == 1) {
                            aph += 1;
                        } else if (item2.platform == 4) {
                            tv += 1;
                        } else if (item2.platform == 8) {
                            ios += 1;
                        } else if (item2.platform == 16) {
                            ipad += 1;
                        }
                    }
                })
            }
            //统计故障占比
            var failuresProportion=Math.round((tv+ios+aph+ipad) / sum * 10000) / 100 + "%";

            dataTableContent += "<tr><td>" + item + "</td><td>" + tv + "</td><td>" + ios + "</td><td>" + aph + "</td><td>" + ipad + "</td><td>" + failuresProportion + "</td></tr>";
            //console.log(item+" "+tv+" "+ios+" "+aph+" "+ipad);

            //拼接故障占比临时变量
            tempContent+=item+"|"+tv+"|"+ios+"|"+aph+"|"+ipad+"|"+failuresProportion+"\n";
        })
        $("#dataTable").html(dataTableContent);
        //拼接content
        content+="### 主要故障占比：\n主要问题 | TV | IOS | Android | ipad|占比 \n------------------|---------------------|----------------------|----------------------|----------------------|---------------------- \n"
            +tempContent+" \n*** \n### 重要故障及问题\n\n> 只能帮你到这里啦~\n\n> 从这里往下的内容要自己写一下\n\n> 主要故障占比可以手动按占比从高到低排下序便于查看";
        $("#content").val(content);
    }
</script>
